#!/usr/bin/env ruby

require 'readline'
require File.join(File.dirname(File.dirname(__FILE__)), 'lib/showterm')

if ARGV.include?('-h') || ARGV.include?('--help')
  puts <<-EOF
Usage: showterm <command to run>

showterm will record the exact output of your session, and upload it to the
internet where it can be replayed by anyone to whom you give the URL.
 EOF
 exit
end

sf, tf = Showterm.record! *ARGV
begin
  Showterm.upload! sf, tf
rescue => e
  File.open("/tmp/showtime.#$$.script", 'w') do |f|
    f.write(sf)
  end

  File.open("/tmp/showtime.#$$.times", 'w') do |f|
    f.write(sf)
  end
  puts [e] + e.backtrace
  puts "-" * 80
  puts "DON'T PANIC"
  puts %(your work is safe in "/tmp/showtime.#$$.script" and "/tmp/showtime.#$$.times")
  puts "To try uploading manually use:"

  puts %(ruby -rshowterm -e'Showterm.upload! File.read("/tmp/showtime.#$$.script"), File.read("/tmp/showtime.#$$.times")')
end
